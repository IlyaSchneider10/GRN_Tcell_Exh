---
title: "Scenic_50_full_genome"
author: "Ilya"
date: "19/05/2022"
output: html_document
---
  
#Download packages
```{r}
#install.packages("dplyr")
#if (!require("BiocManager", quietly = TRUE))
#   install.packages("BiocManager")

#BiocManager::install("GenomicRanges")

#if (!require("BiocManager", quietly = TRUE))
#   install.packages("BiocManager")

#BiocManager::install("TxDb.Hsapiens.UCSC.hg38.knownGene")

#if (!require("BiocManager", quietly = TRUE))
#   install.packages("BiocManager")

#BiocManager::install("Homo.sapiens")

#if (!require("BiocManager", quietly = TRUE))
#   install.packages("BiocManager")

#BiocManager::install("plyranges")
#install.packages("ellipsis")

#if (!require("BiocManager", quietly = TRUE))
#   install.packages("BiocManager")

#BiocManager::install("AUCell")

#if (!require("BiocManager", quietly = TRUE))
#install.packages("BiocManager")

#BiocManager::install("GSEABase")

#if (!require("BiocManager", quietly = TRUE))
#   install.packages("BiocManager")

#BiocManager::install("GEOquery")
#install.packages("openxlsx")
```

#Load packages
```{r}
#install.packages("ellipsis")
#library(dplyr)
library(GenomicRanges)
library(GenomicFeatures)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
library(Homo.sapiens)
library(plyranges)
library(AUCell)
library(GSEABase)
library(GEOquery)
library(openxlsx)
library(stringr)
``` 

#Direcrories
```{r}
main_directory<-"/media/ag-cherrmann/ischneider/GRNTcellExh/scr"
data_directory<-"/media/ag-cherrmann/ischneider/GRNTcellExh/data"
analysis_directory<-"/media/ag-cherrmann/ischneider/GRNTcellExh/analysis"
```

#Edit the input file for the 50 Scenic runs
```{r}
input<-read.csv("/media/ag-cherrmann/cramirez/tcd8ExscSeq/data/maike2020/nina_thimme_raw_counts.csv",header=T, row.names=1)

#Remove RNA genes
input<-t(as.data.frame(input))
input<-input[,17:dim(input)[2]]

#Remove chromosme tags and duplicates
genes<-gsub("\\_.*","",colnames(input))
remove<-which(duplicated(genes))
genes<-genes[-remove] 
input<-input[,-remove]
colnames(input)<-genes
input<-as.data.frame(input)

#Bolouri paper nodes with appropriate nomenclature substitutions
paper_nodes<-c("TNFSF9","TNFRSF9","IL12RB1","IL12RB2","IL21R","FCER1G","CD3","CD8","CD28","PIK3K","EZH2","PRC2","IL2R","RAS","MAPK1","JUN","FOS","BATF","AKT1", "AKT2", "AKT3","FOXO1","EGR2","EGR3","BACH2","ID3","ID2","NFKB1","MTOR","IRF4","TCF3","NFATC2","PPARGC1A","BCL6","PRDM1","NFATC1","CXCR5","TBX21","ZEB2","LAG3","PDCD1","HIF1A","KLRG1","PPARA","CTLA4","HAVCR2","BTLA","NR4A1","CD160","TIGIT","IL15RA","CD244","CD2B4","MYC","RUNX3","EOMES","FAS","FASLG","GZMA","GZMB","PRF1","IFNG")

paper_substitutions<-list("HNF1A","TNFRSF9",c("IL12RB1","IL12RB2"),c("AKT1","AKT2","AKT3"),"TCF3","PRDM1","TBX21","PDCD1","PPARA","TIM3","TNFSF9","FCER1G","MAPK1","PPARGC1A","IL15RA")
names(paper_substitutions)<-c("TCF1","41BB","IL12R","AKT","E2A","BLIMP1","TBET","PD1","PPAR","TIM3","CD137L","CD3","MAPK","PGC1A","IL15R")

#Keep 5000 genes with highest variance, they must include all the paper nodes
input_var<-apply(input,2,var)
input_var_sorted<-sort(input_var,decreasing =T)
paper_nodes_in_input<-which(names(input_var_sorted) %in% paper_nodes)
input_genes<-head(sort(input_var,decreasing =T),5000)
paper_nodes_left_out<-paper_nodes_in_input[paper_nodes_in_input>=5000]
paper_nodes_left_out<-input_var_sorted[paper_nodes_left_out]
paper_nodes_left_out<-paper_nodes_left_out[paper_nodes_left_out>0]
input_genes<-append(input_genes,paper_nodes_left_out)
input<-input[,names(input_genes)]
```

#Export the input table
```{r eval=FALSE, echo=FALSE}
setwd("/media/ag-cherrmann/ischneider/GRNTcellExh/data/SCENIC50/Input")
write.table(input, file='scenic_input_full_genome.tsv', quote=FALSE, sep='\t', row.names = T)

#Code for bash to iterate Scenic 50 times
#bash /media/ag-cherrmann/ischneider/GRNTcellExh/scr/Scenic.txt
```

```{r}
#Save the table
setwd(analysis_directory)
write.table(input, file='scenic_input_full_genome.tsv', quote=FALSE, sep='\t', row.names = T)
```

#Select all TFs from aucell files
```{r}
#Number of scenic runs
n=50 
#Open all aucell files and keep TFs from them
aucell_tfs<-vector("list",length=n)
names(aucell_tfs)<-seq(n)
for (x in seq(n)){
  aucell<-read.csv(paste0(data_directory,"/SCENIC50/Output_full_genome/run_",as.character(x),"/aucell.csv"),header=T,row.names = 1)
  aucell_tfs[[as.character(x)]]<-colnames(aucell)
}
aucell_tfs<-lapply(aucell_tfs, gsub, pattern="[...]",replacement="")
scenic_output_tfs<-unique(unlist(aucell_tfs))
```

#Adj files
```{r echo=FALSE, eval=FALSE}
#Open adj files
adj_interactions<-vector("list",length=n)
names(adj_interactions)<-seq(n)
for (x in seq(n)){
  adj<-read.table(paste0(data_directory,"/SCENIC50/Output_full_genome/run_",as.character(x),"/adj.tsv"),sep='\t',header=T)
  adj_interactions[[as.character(x)]]<-adj
}
```

#Get targets for TFs from reg files
```{r}
#Get target column from each reg file
reg_targets<-vector("list",length=n)
names(reg_targets)<-seq(n)
for (x in seq(n)){
  reg<-read.csv(paste0(data_directory,"/SCENIC50/Output_full_genome/run_",as.character(x),"/reg.csv"),header=T)
  reg_targets[[as.character(x)]]<-reg
}

change_reg_format<-function(r){
  names<-c(r[2,1:2],r[1,3:dim(r)[2]])
  y<-setNames(r,names)
  y<-y[-c(1,2),]
}
reg_targets<-lapply(reg_targets,change_reg_format)

for (x in names(reg_targets)){
  reg_targets[[x]]<-split(reg_targets[[x]],reg_targets[[x]]$TF)
}

for (x in names(reg_targets)){
  for (y in names(reg_targets[[x]])){
    reg_targets[[x]][[y]]<-reg_targets[[x]][[y]]$TargetGenes
  }
}

#Extract target names
extract_targets <- function(x){
  targets <- regmatches(x, gregexpr("'[^']*'", x))[[1]] 
  gsub("'", '', targets)
}

extract_all_unique_targets<-function(obj){
  unique(extract_targets(paste0(c(obj),collapse = "")))
}


for (x in names(reg_targets)){
  for(y in names(reg_targets[[x]])){
    reg_targets[[x]][[y]]<-extract_all_unique_targets(reg_targets[[x]][[y]])
    
  }
}
regulons<-reg_targets

for (x in names(reg_targets)){
  for(y in names(reg_targets[[x]])){
    reg_targets[[x]][[y]]<-reg_targets[[x]][[y]][reg_targets[[x]][[y]] %in% scenic_output_tfs] #we keep not only TF->TF interactions
  }
}

#Remove self regulation
for (y in names(reg_targets)){
  for (x in scenic_output_tfs){
    lookup<-x==reg_targets[[y]][[x]]
    pos<-which(lookup==T)
    if(sum(lookup)!=0){
      reg_targets[[y]][[x]]<-reg_targets[[y]][[x]][-c(pos)]
    }
  }
} 

#Remove TFs with no targets
for (x in names(reg_targets)){
  remove<-which(lapply(reg_targets[[x]], length)==0)
  reg_targets[[x]]<-reg_targets[[x]][-remove]
}

reg_tfs<-c()
for (x in names(reg_targets)){
  reg_tfs<-append(reg_tfs,names(reg_targets[[x]]))
}
reg_tfs<-unique(reg_tfs)
```

#Create a file with all the interactions that we want to keep
```{r}
#Put all interactions in dataframe form
all_interactions<-c()
for (z in names(reg_targets)){
  for(x in names(reg_targets[[z]])){
    for(y in reg_targets[[z]][[x]]){
      all_interactions<-append(all_interactions,paste0(x,"->",y))
    }
  }
}

frequency<-(table(all_interactions))
all_unique_interactions<-names(frequency)

interactions_summary<-as.data.frame(matrix(ncol=3,nrow=length(unlist(all_unique_interactions))))
colnames(interactions_summary)<-c("TF", "target","frequency")

interactions_summary$frequency<-as.numeric(frequency)
interactions_summary$TF<-sub("->.*", "", all_unique_interactions)
interactions_summary$target<-sub(".*->", "", all_unique_interactions)

#Add frequency filter
frequency_filter=40
for(x in seq(dim(interactions_summary)[1])){
  f<-interactions_summary$frequency[x]
  if(f>=frequency_filter){
    interactions_summary[x,"frequency_filter"]<-T
  }else{
    interactions_summary[x,"frequency_filter"]<-F
  }
}
```

#Select best peaks for cistrome
```{r}
#Work with cistrome description file
setwd(data_directory)
cistrome_description<-read.delim("human_factor_full_QC.txt")
cistrome_blood<-cistrome_description[cistrome_description$Tissue_type=="Blood",]

#File 38912 is empty and gives us an error in the loop so we remove it
cistrome_blood<-cistrome_blood[cistrome_blood$DCid!=38912,]
cistrome_blood_file_names<-cistrome_blood$DCid

#Open corresponding files
cistrome_blood_files<-vector("list", length(cistrome_blood_file_names))
names(cistrome_blood_files)<-cistrome_blood_file_names
for (x in cistrome_blood_file_names){
  cistrome_blood_files[[as.character(x)]]<-as.data.frame(read.table(paste0(data_directory,"/human_factor/",as.character(x),"_sort_peaks.narrowPeak.bed"),header = FALSE, sep="\t",stringsAsFactors=FALSE, quote=""))
}

#Keep only TFs that appear in scenic output
names(cistrome_blood_files)<-cistrome_blood$Factor
cistrome_blood_files<-cistrome_blood_files[names(cistrome_blood_files) %in% scenic_output_tfs]

#Split the list into groups according to a TF
cistrome_blood_files<-split(cistrome_blood_files,names(cistrome_blood_files))
cistrome_blood_files<-lapply(cistrome_blood_files, dplyr::bind_rows)

#Select top 1000 peaks for each TF
cistrome_best_peaks<-cistrome_blood_files
for (y in names(cistrome_best_peaks)){
  best_peaks<-unique(head(sort(cistrome_best_peaks[[y]]$V5, decreasing=T),1000))
  keep<-c()
  for (x in best_peaks){
    keep<-append(keep,which(cistrome_best_peaks[[y]]$V5==x))
  }
  cistrome_best_peaks[[y]]<-cistrome_best_peaks[[y]][keep,]
}
```

#Prepare Cistrome peaks for intersection with reference genome
```{r}
#Change peak format
change_peak_format<-function(peak){
  y<-peak[,c(1,2,3,6)]
  new_names<-c("chr","start","end","strand")
  setNames(y,new_names)
}

cistrome_best_peaks<-lapply(cistrome_best_peaks,change_peak_format)

#Extend the peaks by 10 kb in both directions
extension=10000
extend_peaks<-function(peak, e){
  peak<-mutate(peak,start=start-e)
  peak<-mutate(peak,end=end+e)
}
cistrome_extended_peaks<-lapply(cistrome_best_peaks,extend_peaks,e=extension)

for(y in names(cistrome_extended_peaks)){
  for (x in seq_along(cistrome_extended_peaks[[y]]$start)){
    if(cistrome_extended_peaks[[y]]$start[x]<0){
      cistrome_extended_peaks[[y]][x,2]<-0
    }
  }
}
cistrome_granges_peaks<-cistrome_extended_peaks
#make Granges objects
for (x in names(cistrome_extended_peaks)){
  cistrome_granges_peaks[[x]]<-makeGRangesFromDataFrame(cistrome_extended_peaks[[x]])
}
```

#Overlap peaks with reference genome
```{r}
#Get reference transcripts
txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene
transcripts <- GenomicFeatures::genes(txdb)

#Get reference genes
TxDb(Homo.sapiens) <- txdb
genes_list <- transcriptsBy(Homo.sapiens, columns = "SYMBOL")
genes <- unlist(genes_list)
cistrome_overlap_transcripts<-lapply(cistrome_granges_peaks, GenomicRanges::intersect, y=transcripts, ignore.strand=T)

#Create overlap and obtain gene names
cistrome_overlap_genes<-lapply(cistrome_overlap_transcripts,plyranges::find_overlaps,y=genes)
cistrome_overlap_gene_names<-lapply(cistrome_overlap_genes,function(x){unique(unlist(x$SYMBOL))})

total_genes<-unique(unlist(cistrome_overlap_gene_names))
scenic_cistrome_overlap<-scenic_output_tfs[scenic_output_tfs %in% total_genes]
paper_nodes[paper_nodes %in% scenic_cistrome_overlap]

cistrome_overlap_gene_names<-lapply(cistrome_overlap_gene_names, function(x){x[x %in% scenic_output_tfs]})

#Add cistrome filter to interactions_summary
cistrome_confirmed_interactions<-c()
for (z in names(cistrome_overlap_gene_names)){
  for(y in cistrome_overlap_gene_names[[z]]){
    cistrome_confirmed_interactions<-append(cistrome_confirmed_interactions,paste0(z,"->",y))
  }
}
our_cistrome_confirmed_interactions<-cistrome_confirmed_interactions[cistrome_confirmed_interactions %in% all_unique_interactions]

interactions_summary["cistrome_filter"]<-F
interactions_summary[which(all_unique_interactions %in% our_cistrome_confirmed_interactions),"cistrome_filter"]<-T
```

#Multiple amount of peaks
```{r eval=FALSE,echo=FALSE}
#Change peak format
change_peak_format<-function(peak){
  y<-peak[,c(1,2,3,6)]
  new_names<-c("chr","start","end","strand")
  setNames(y,new_names)
}

extend_peaks<-function(peak, e){
  peak<-mutate(peak,start=start-e)
  peak<-mutate(peak,end=end+e)
}

#Output of this loop: Granges object of the extended TF ranges overlap with gene regeions. It contains a metacolumn with gene names which we etract in further loops
peaks_amount<-c(100,250,500,1000,2500,5000,10000)
peak_extensions<-c(0,1000,5000,10000,50000,100000)
cistrome_best_peaks_options<-vector("list",length(peaks_amount))
names(cistrome_best_peaks_options)<-peaks_amount
for (z in peaks_amount){
  copy<-cistrome_blood_files
  for (y in names(copy)){
    best_peaks<-unique(head(sort(copy[[y]]$V5, decreasing=T),z))
    keep<-c()
    for (x in best_peaks){
      keep<-append(keep,which(copy[[y]]$V5==x))
    }
    copy[[y]]<-copy[[y]][keep,]
  }
  copy<-lapply(copy,change_peak_format)
  extension_options<-vector("list",length(peak_extensions))
  names(extension_options)<-peak_extensions
  for(e in peak_extensions){
    extension_options[[as.character(e)]]<-lapply(copy,extend_peaks,e=e)
    for (h in names(extension_options)){
      for(g in names(extension_options[[h]])){
        for (l in seq_along(extension_options[[h]][[g]]$start)){
          if(extension_options[[h]][[g]]$start[l]<0){
            extension_options[[h]][[g]][l,2]<-0
          }
        }
      }
    }
    for (v in names(extension_options)){
      for (j in names(extension_options[[v]])){
        extension_options[[v]][[j]]<-makeGRangesFromDataFrame(extension_options[[v]][[j]])
      }
      extension_options[[v]]<-lapply(extension_options[[v]], GenomicRanges::intersect, y=transcripts, ignore.strand=T)
      extension_options[[v]]<-lapply(extension_options[[v]],plyranges::find_overlaps,y=genes)
    }
  }
  cistrome_best_peaks_options[[as.character(z)]]<-extension_options
}

#Back up mid results
save1<-cistrome_best_peaks_options

cistrome_best_peaks_options<-save1
#Extract metacolumn with gene names
for (x in names(cistrome_best_peaks_options)){
  for (y in names(cistrome_best_peaks_options[[x]])){
    cistrome_best_peaks_options[[x]][[y]]<-lapply(cistrome_best_peaks_options[[x]][[y]],function(h){unique(unlist(h$SYMBOL))})
  }
}

#Create 3 output lists about nodes
total_genes_options<-cistrome_best_peaks_options

scenic_cistrome_overlap_options<-cistrome_best_peaks_options

scenic_cistrome_paper_overlap_options<-cistrome_best_peaks_options

for (x in names(cistrome_best_peaks_options)){
  for (y in names(cistrome_best_peaks_options[[x]])){
    total_genes_options[[x]][[y]]<-unique(unlist(cistrome_best_peaks_options[[x]][[y]]))
    scenic_cistrome_overlap_options[[x]][[y]]<-scenic_output_tfs[scenic_output_tfs %in% total_genes_options[[x]][[y]]]
    scenic_cistrome_paper_overlap_options[[x]][[y]]<-paper_nodes[paper_nodes %in% scenic_cistrome_overlap_options[[x]][[y]]]
  }
}

#See how many interactions are confirmed
for (x in names(cistrome_best_peaks_options)){
  for (y in names(cistrome_best_peaks_options[[x]])){
    cistrome_best_peaks_options[[x]][[y]]<-lapply(cistrome_best_peaks_options[[x]][[y]], function(x){x[x %in% scenic_output_tfs]})
    cistrome_confirmed_interactions<-c()
    for (z in names(cistrome_best_peaks_options[[x]][[y]])){
      for(d in cistrome_best_peaks_options[[x]][[y]][[z]]){
        cistrome_confirmed_interactions<-append(cistrome_confirmed_interactions,paste0(z,"->",d))
      }
    }
    cistrome_best_peaks_options[[x]][[y]]<-cistrome_confirmed_interactions[cistrome_confirmed_interactions %in% all_unique_interactions]
  }
}

#Summarize everything in one list
summary_peaks_options<-cistrome_best_peaks_options
tot_genes<-list()
scenic_cistrome<-list()
scenic_cistrome_paper<-list()
scenic_cistrome_interactions<-list()
categories<-list(tot_genes,scenic_cistrome,scenic_cistrome_paper,scenic_cistrome_interactions)
names(categories)<-c("tot_genes","scenic_cistrome","scenic_cistrome_paper","scenic_cistrome_interactions")

for (x in names(summary_peaks_options)){
  for (y in names(summary_peaks_options[[x]])){
    summary_peaks_options[[x]][[y]]<-categories
    summary_peaks_options[[x]][[y]][["tot_genes"]]<-total_genes_options[[x]][[y]]
    summary_peaks_options[[x]][[y]][["scenic_cistrome"]]<-scenic_cistrome_overlap_options[[x]][[y]]
    summary_peaks_options[[x]][[y]][["scenic_cistrome_paper"]]<-scenic_cistrome_paper_overlap_options[[x]][[y]]
    summary_peaks_options[[x]][[y]][["scenic_cistrome_interactions"]]<-cistrome_best_peaks_options[[x]][[y]]
  }
}
```

#Open ATAC-seq data
```{r echo=FALSE, eval=FALSE}
setwd(data_directory)
gunzip("CHaRs_annotated.tsv.gz")
```

#ATAC-seq data
```{r}
#Selecet only targets and TFs from atac_seq file
atac_seq<-read.table(paste0(data_directory,"/CHaRs_annotated.tsv"),sep='\t',header=T)
keep<-c()
for (x in seq(dim(atac_seq)[1])){
  if(atac_seq$genes[x]!=""){
    keep<-append(keep,x)
  }
}
atac_seq<-atac_seq[keep,]


atac_seq_list<-vector("list", dim(atac_seq)[1])
names(atac_seq_list)<-atac_seq$genes
for (x in seq(length(atac_seq_list))){
  
  str<-atac_seq$TF[[x]]
  
  one<-sub(";.*", "", str)
  two<-str_match_all(str, ";\\s*(.*?)\\s*;")[[1]][,2]
  three<-sub(".*;", "", str)
  
  res<-c(one, two, three)
  
  atac_seq_list[[x]]<-res
  
}

atac_seq_list<-split(atac_seq_list,names(atac_seq_list))
atac_seq_list<-lapply(atac_seq_list,unlist)
atac_seq_list<-lapply(atac_seq_list, unique)

#Deal with complex target names
multiple_targets<-atac_seq_list[grep(";", names(atac_seq_list))]
converted_targets<-list()
for (x in names(multiple_targets)){
  one<-sub(";.*", "", x)
  two<-str_match_all(x, ";\\s*(.*?)\\s*;")[[1]][,2]
  three<-sub(".*;", "", x)
  
  res<-c(one, two, three)
  
  for (y in res){
    converted_targets[[y]]<-multiple_targets[[x]]
  }
}

atac_seq_list<-atac_seq_list[-which(names(atac_seq_list) %in% names(multiple_targets))]
atac_seq_list<-c(converted_targets,atac_seq_list)
atac_seq_list<-split(atac_seq_list,names(atac_seq_list))
atac_seq_list<-lapply(atac_seq_list,unlist)
atac_seq_list<-lapply(atac_seq_list, unique)

#Keep only TF->TF interactions
atac_seq_list<-atac_seq_list[which(names(atac_seq_list) %in% scenic_output_tfs)]

for (x in names(atac_seq_list)){
  atac_seq_list[[x]]<-atac_seq_list[[x]][atac_seq_list[[x]] %in% scenic_output_tfs]
}

#Create ATAC-seq interactions
atac_seq_interactions<-c()
for (x in names(atac_seq_list)){
  for(y in atac_seq_list[[x]]){
    atac_seq_interactions<-append(atac_seq_interactions,paste0(y,"->",x))
  }
}

#Add interactions to the interactions_summary table 
interactions_summary["ataq-seq"]<-F
interactions_summary[which(all_unique_interactions %in% atac_seq_interactions),"ataq-seq"]<-T

interactions_summary[interactions_summary$`ataq-seq`==T,]
```

#Create regulon interactions table
```{r eval=FALSE, echo=FALSE}
#Create a dataframe with all interactions
all_regulon_interactions<-c()
for (z in names(regulons)){
  for(x in names(regulons[[z]])){
    for(y in regulons[[z]][[x]]){
      all_regulon_interactions<-append(all_regulon_interactions,paste0(x,"->",y))
    }
  }
}

regulon_frequency<-(table(all_regulon_interactions))
all_unique_regulon_interactions<-names(regulon_frequency)

regulon_interactions_summary<-as.data.frame(matrix(ncol=3,nrow=length(unlist(all_unique_regulon_interactions))))
colnames(regulon_interactions_summary)<-c("TF", "target","frequency")

regulon_interactions_summary$frequency<-as.numeric(regulon_frequency)
regulon_interactions_summary$TF<-sub("->.*", "", all_unique_regulon_interactions)
regulon_interactions_summary$target<-sub(".*->", "", all_unique_regulon_interactions)

#Add frequency filter
frequency_filter=40
for(x in seq(dim(regulon_interactions_summary)[1])){
  f<-regulon_interactions_summary$frequency[x]
  if(f>=frequency_filter){
    regulon_interactions_summary[x,"frequency_filter"]<-T
  }else{
    regulon_interactions_summary[x,"frequency_filter"]<-F
  }
}

#Save the table
setwd(analysis_directory)
write.table(regulon_interactions_summary, file='regulon_interactions_summary.tsv', quote=FALSE, sep='\t', row.names = T)
```

#Select data to create a single aucell file and binarize it
```{r}
#Open regulon table
regulon_interactions_summary<-read.table(paste0(analysis_directory,"/regulon_interactions_summary.tsv"),sep='\t',header=T)

#Create a list with all regulons
overall_regulons<-split(regulon_interactions_summary, regulon_interactions_summary$TF)
for (x in names(overall_regulons)){
  overall_regulons[[x]]<-overall_regulons[[x]]$target
}

#Remove regulons that are smaller than 15
remove<-which(lapply(overall_regulons, length)<=15)
remove_names<-names(remove)
overall_regulons<-overall_regulons[-remove]

regulon_interactions_summary<-regulon_interactions_summary[-which(regulon_interactions_summary$TF %in% remove_names),]
regulon_interactions_summary<-regulon_interactions_summary[-which(regulon_interactions_summary$target %in% remove_names),]

#Create AUCell input
regulon_frequency_filter<-regulon_interactions_summary[regulon_interactions_summary$frequency_filter==T,]
regulon_targets<-unique(unique(regulon_frequency_filter$target))

input_regulons<-overall_regulons[unique(regulon_frequency_filter$TF)]
input_for_single_aucell<-t(input[,colnames(input) %in% regulon_targets])
expr_matrix <- as(input_for_single_aucell, "dgCMatrix")

#Run AUCell
cells_rankings<-AUCell_buildRankings(expr_matrix)
cells_AUC <- AUCell_calcAUC(input_regulons, cells_rankings, aucMaxRank = ceiling(0.5 * nrow(cells_rankings)))
cells_assignment <- AUCell_exploreThresholds(cells_AUC, plotHist=TRUE, assign=TRUE) 
```

#Heatmap according to cell types
```{r}
setwd(data_directory)
cell_annotations<-read.xlsx("nina_annotations.xlsx")
cell_types<-split(cell_annotations,cell_annotations$TYPE)

try<-aucell
for (x in names(cell_types)){
  cell_types[[x]]<-try[cell_types[[x]]$CELLID,]
}
cell_types<-lapply(cell_types,colMeans)


heat_map<-data.frame(matrix(nrow=113, ncol=3))
colnames(heat_map)<-names(cell_types)
rownames(heat_map)<-names(cell_types[[1]])

for(x in seq_along(cell_types)){
  heat_map[,x]<-cell_types[[x]]
}

heatmap(as.matrix(heat_map),Colv = NA, Rowv = NA)
```

